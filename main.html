<!--
    Contributors:
-->
<!-- 
    About the Project:
-->

<!DOCTYPE html>
<html>
<head>
    <title>CMPM163 Final Project</title>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
         }
    </style>
</head>
<body>

    <div id="container"></div>

    <!-- Loading external libraries -->
    <script src="js/three.js"></script>
    <script src="js/cmengine.js"></script>
    <script src="js/OrbitControls.js"></script>

    <!-- Loading external shaders -->
    <script src="shaders/basic-shader.js"></script>
	<script src="shaders/sand-shaders.js"></script>
    <script src="shaders/water-shader.js"></script>

    <!-- Loading external objects -->
	<script src="js/objects/flat-sand-terrain.js"></script>
    <script src="js/objects/simple-box.js"></script>
    <script src="js/objects/water-plane.js"></script>

    <script>

        var container = document.getElementById('container');

        // renderer
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild( renderer.domElement );

        // scene
        var scene = new THREE.Scene();
		
		//skybox - will find a better/clear one at some point
		var cubeLoader = new THREE.CubeTextureLoader();
		cubeLoader.setPath('images/skybox/temp/');
		scene.background = cubeLoader.load(['left.jpg', 'right.jpg',
									'top.jpg', 'bottom.jpg',
									'back.jpg', 'front.jpg']);
		
		// sand textures + heightmap
		var loader = new THREE.ImageLoader();
		loader.setPath('images/sand/');
		var sandTexture = loader.load('sand1.jpg');
		var sandNormal = loader.load('sand1normal.jpg');
		var sandHeight = loader.load('heightmap.png');

        // camera
        var camera = new THREE.PerspectiveCamera( 50, window.innerWidth/window.innerHeight, 0.1, 1000 );
        camera.position.z = 15.0;
        camera.position.y = 10.0;

        // FrameBufferObject: bufferScene will contain everything in scene except for the water
        var bufferObject = new THREE.WebGLRenderTarget( window.innerWidth, window.innerHeight); // this creates an off-screen buffer. (Frame Buffer Object)!Update this for windowResize
        var bufferScene = new THREE.Scene();
		cubeLoader.setPath('images/skybox/temp/');
        bufferScene.background = cubeLoader.load(['left.jpg', 'right.jpg',
                                            'top.jpg', 'bottom.jpg',
                                            'back.jpg', 'front.jpg']);


        // add all objects to buffer scene except for water
        var bufferBox = createSimpleBox(1.0,1.0,1.0);
        bufferScene.add(bufferBox);

        // create objects
        var water = createWaterPlane(20, 20, bufferObject.texture);
        var box = createSimpleBox(1.0, 1.0, 1.0);
		var sand = createSand(50, 50, sandTexture, sandNormal, sandHeight);

        // add objects to the scene
        scene.add(box);
        scene.add(water);
		scene.add(sand);

        // Creating a clipping plane that is applied to the whole 
        var globalPlane = new THREE.Plane( new THREE.Vector3(0, -1, 0), water.position.y);
        renderer.clippingPlanes = [globalPlane];


        // CMENGINE
        CMENGINE.Start( scene, renderer, camera, bufferScene, bufferObject );
        CMENGINE.Update();

    </script>

</body>
</html>